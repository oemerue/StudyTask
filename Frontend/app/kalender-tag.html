<!doctype html>
<html lang="de">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kalendertag – StudyTasks</title>

    <link rel="stylesheet" href="../src/styles.css" />
    <link rel="icon" href="../images/Logo.png" />
</head>

<body>

    <header class="site-header">
        <div class="container header-inner">
            <a class="brand" href="dashboard.html">
                <img src="../images/Logo.png" class="brand-logo" />
            </a>
        </div>
    </header>

    <main class="section">
        <div class="container" style="max-width:800px;">
            <h1 class="page-title">Aufgaben an diesem Tag</h1>

            <div id="dayTasks" style="margin-top:16px;"></div>

            <a href="kalender.html" class="btn btn-ghost" style="margin-top:24px;">
            ← Zurück zum Kalender
        </a>
        </div>
    </main>

    <footer class="site-footer">
        <p class="muted">© <span id="y"></span> StudyTasks</p>
    </footer>

    <script>
        document.getElementById("y").textContent = new Date().getFullYear();
    </script>

    <script src="js/auth-check.js"></script>
    <script src="js/api.js"></script>

    <script>
        const params = new URLSearchParams(window.location.search);
        const groupId = params.get("group_id");
        const date = params.get("date");

        if (!groupId || !date) {
            window.location.href = "kalender.html";
        }

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        (async() => {
            const container = document.getElementById("dayTasks");
            container.innerHTML = "Lade…";

            try {
                const tasks = await apiRequest(
                    "/tasks/getTasksByGroup.php?group_id=" + encodeURIComponent(groupId)
                );

                const filtered = Array.isArray(tasks) ?
                    tasks.filter(t => t.due_at && String(t.due_at).startsWith(date)) : [];

                if (filtered.length === 0) {
                    container.innerHTML = "<p>Keine Aufgaben an diesem Tag.</p>";
                    return;
                }

                container.innerHTML = "";

                filtered.forEach(t => {
                    const el = document.createElement("article");
                    el.className = "feature task-card";

                    el.innerHTML = `
                    <h3>${escapeHtml(t.title || "Ohne Titel")}</h3>
                    <p class="muted">Status: ${escapeHtml(t.status || "—")}</p>
                `;

                    container.appendChild(el);
                });

            } catch (e) {
                console.error(e);
                container.innerHTML = "<p>Fehler beim Laden der Aufgaben.</p>";
            }
        })();
    </script>

    <script src="js/admin-nav.js"></script>

</body>

</html>